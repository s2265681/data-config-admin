# Data Config Admin - é¡¹ç›®ç»“æ„è¯´æ˜

## ğŸ“ é¡¹ç›®æ¦‚è¿°

Data Config Admin æ˜¯ä¸€ä¸ªåŸºäºæ–‡ä»¶å¤¹çš„é…ç½®æ–‡ä»¶ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒåœ¨ AWS S3 å’Œ GitHub ä»“åº“ä¹‹é—´è¿›è¡ŒåŒå‘åŒæ­¥ã€‚é¡¹ç›®é‡‡ç”¨ Serverless æ¶æ„ï¼Œä½¿ç”¨ AWS Lambda å‡½æ•°å¤„ç† S3 äº‹ä»¶ï¼Œå®ç°é…ç½®æ–‡ä»¶çš„è‡ªåŠ¨åŒ–ç®¡ç†ã€‚

## ğŸ—ï¸ å®Œæ•´é¡¹ç›®ç»“æ„

```
data-config-admin/
â”œâ”€â”€ ğŸ“ .github/                          # GitHub ç›¸å…³é…ç½®
â”‚   â””â”€â”€ ğŸ“ workflows/                     # GitHub Actions å·¥ä½œæµ
â”‚       â”œâ”€â”€ ğŸ“„ github-to-s3-staging-sync.yml    # Stagingç¯å¢ƒåŒæ­¥å·¥ä½œæµ
â”‚       â””â”€â”€ ğŸ“„ github-to-s3-production-sync.yml # Productionç¯å¢ƒåŒæ­¥å·¥ä½œæµ
â”‚
â”œâ”€â”€ ğŸ“ .serverless/                       # Serverless Framework éƒ¨ç½²ç¼“å­˜
â”‚
â”œâ”€â”€ ğŸ“ app-config/                        # åº”ç”¨ç¨‹åºé…ç½®æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ ğŸ“ config/                        # ä¸»è¦é…ç½®æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ ğŸ“ staging/                   # Stagingç¯å¢ƒé…ç½®
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ test.json              # ä¸»è¦é…ç½®æ–‡ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ 1.json                 # æ–°å¢é…ç½®æ–‡ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ 2.json                 # æ–°å¢é…ç½®æ–‡ä»¶
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ test1-2.json           # æµ‹è¯•é…ç½®æ–‡ä»¶1-2
â”‚   â”‚   â””â”€â”€ ğŸ“ production/                # Productionç¯å¢ƒé…ç½®
â”‚   â”‚       â”œâ”€â”€ ğŸ“„ test.json              # ä¸»è¦é…ç½®æ–‡ä»¶
â”‚   â”‚       â”œâ”€â”€ ğŸ“„ 1.json                 # æ–°å¢é…ç½®æ–‡ä»¶
â”‚   â”‚       â”œâ”€â”€ ğŸ“„ 2.json                 # æ–°å¢é…ç½®æ–‡ä»¶
â”‚   â”‚       â””â”€â”€ ğŸ“„ test1-2.json           # æµ‹è¯•é…ç½®æ–‡ä»¶1-2
â”‚   â”œâ”€â”€ ğŸ“ config2/                       # æ¬¡è¦é…ç½®æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ ğŸ“ staging/                   # Stagingç¯å¢ƒé…ç½®
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ test2.json             # ç¬¬äºŒä¸ªé…ç½®æ–‡ä»¶
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ test3.json             # ç¬¬ä¸‰ä¸ªé…ç½®æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ ğŸ“ production/                # Productionç¯å¢ƒé…ç½®
â”‚   â”‚       â”œâ”€â”€ ğŸ“„ test2.json             # ç¬¬äºŒä¸ªé…ç½®æ–‡ä»¶
â”‚   â”‚       â””â”€â”€ ğŸ“„ test3.json             # ç¬¬ä¸‰ä¸ªé…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ ğŸ“ config3/                       # ç¬¬ä¸‰æ–¹é…ç½®æ–‡ä»¶
â”‚       â”œâ”€â”€ ğŸ“ staging/                   # Stagingç¯å¢ƒé…ç½®
â”‚       â”‚   â””â”€â”€ ğŸ“„ test4.json             # ç¬¬å››ä¸ªé…ç½®æ–‡ä»¶
â”‚       â””â”€â”€ ğŸ“ production/                # Productionç¯å¢ƒé…ç½®
â”‚           â””â”€â”€ ğŸ“„ test4.json             # ç¬¬å››ä¸ªé…ç½®æ–‡ä»¶
â”‚
â”œâ”€â”€ ğŸ“ config/                            # é¡¹ç›®é…ç½®ç›®å½•
â”‚   â”œâ”€â”€ ğŸ“„ folders.json                   # æ–‡ä»¶å¤¹ç®¡ç†é…ç½®æ–‡ä»¶ï¼ˆæ ¸å¿ƒé…ç½®ï¼‰
â”‚   â””â”€â”€ ğŸ“„ README.md                      # é…ç½®è¯´æ˜æ–‡æ¡£
â”‚
â”œâ”€â”€ ğŸ“ handlers/                          # AWS Lambda å‡½æ•°å¤„ç†å™¨
â”‚   â”œâ”€â”€ ğŸ“„ s3-to-github.js                # S3åˆ°GitHubåŒæ­¥å¤„ç†å™¨ï¼ˆä¸»è¦ï¼‰
â”‚   â””â”€â”€ ğŸ“„ s3-to-github-production.js     # S3åˆ°GitHubåŒæ­¥å¤„ç†å™¨ï¼ˆç”Ÿäº§ç¯å¢ƒä¸“ç”¨ï¼‰
â”‚
â”œâ”€â”€ ğŸ“ node_modules/                      # Node.js ä¾èµ–åŒ…
â”‚
â”œâ”€â”€ ğŸ“ plugins/                           # Serverless Framework æ’ä»¶
â”‚   â””â”€â”€ ğŸ“„ dynamic-s3-events.js           # åŠ¨æ€S3äº‹ä»¶é…ç½®æ’ä»¶
â”‚
â”œâ”€â”€ ğŸ“ scripts/                           # ç®¡ç†è„šæœ¬ç›®å½•
â”‚   â”œâ”€â”€ ğŸ“„ deploy.js                      # éƒ¨ç½²è„šæœ¬ï¼ˆå¸¦é…ç½®éªŒè¯ï¼‰
â”‚   â”œâ”€â”€ ğŸ“„ manage-folders.js              # æ–‡ä»¶å¤¹ç®¡ç†è„šæœ¬
â”‚   â”œâ”€â”€ ğŸ“„ migrate-to-folders.js          # è¿ç§»åˆ°æ–‡ä»¶å¤¹ç»“æ„è„šæœ¬
â”‚   â”œâ”€â”€ ğŸ“„ monitor-folders-sync.js        # ç›‘æ§æ–‡ä»¶å¤¹åŒæ­¥çŠ¶æ€è„šæœ¬
â”‚   â”œâ”€â”€ ğŸ“„ pull-from-s3.js                # ä»S3æ‹‰å–æ–‡ä»¶åˆ°GitHubè„šæœ¬
â”‚   â”œâ”€â”€ ğŸ“„ sync-folders-to-s3.js          # åŒæ­¥æ–‡ä»¶å¤¹åˆ°S3è„šæœ¬
â”‚   â””â”€â”€ ğŸ“„ update-lambda.js               # æ›´æ–°Lambdaå‡½æ•°è„šæœ¬
â”‚
â”œâ”€â”€ ğŸ“ test/                              # æµ‹è¯•æ–‡ä»¶ç›®å½•
â”‚   â””â”€â”€ ğŸ“„ sync.test.js                   # åŒæ­¥åŠŸèƒ½æµ‹è¯•æ–‡ä»¶
â”‚
â”œâ”€â”€ ğŸ“ utils/                             # å·¥å…·ç±»ç›®å½•
â”‚   â”œâ”€â”€ ğŸ“„ folder-manager.js              # æ–‡ä»¶å¤¹ç®¡ç†å™¨ï¼ˆæ ¸å¿ƒå·¥å…·ç±»ï¼‰
â”‚   â””â”€â”€ ğŸ“„ generate-s3-arns.js            # S3 ARNç”Ÿæˆå™¨
â”‚
â”œâ”€â”€ ğŸ“„ .DS_Store                          # macOSç³»ç»Ÿæ–‡ä»¶
â”œâ”€â”€ ğŸ“„ .gitignore                         # Gitå¿½ç•¥æ–‡ä»¶é…ç½®
â”œâ”€â”€ ğŸ“„ deploy.sh                          # éƒ¨ç½²Shellè„šæœ¬
â”œâ”€â”€ ğŸ“„ env.example                        # ç¯å¢ƒå˜é‡ç¤ºä¾‹æ–‡ä»¶
â”œâ”€â”€ ğŸ“„ FOLDER_MANAGEMENT.md               # æ–‡ä»¶å¤¹ç®¡ç†è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ ğŸ“„ package-lock.json                  # npmä¾èµ–é”å®šæ–‡ä»¶
â”œâ”€â”€ ğŸ“„ package.json                       # é¡¹ç›®é…ç½®å’Œä¾èµ–ç®¡ç†
â”œâ”€â”€ ğŸ“„ README.md                          # é¡¹ç›®ä¸»è¦è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ ğŸ“„ response.json                      # å“åº”ç¤ºä¾‹æ–‡ä»¶
â”œâ”€â”€ ğŸ“„ SCRIPTS_USAGE.md                   # è„šæœ¬ä½¿ç”¨è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ ğŸ“„ serverless.yml                     # Serverless Framework é…ç½®æ–‡ä»¶
â”œâ”€â”€ ğŸ“„ SETUP.md                           # é¡¹ç›®è®¾ç½®è¯´æ˜æ–‡æ¡£
â””â”€â”€ ğŸ“„ æŠ€æœ¯æ–‡æ¡£.md                        # æŠ€æœ¯å®ç°æ–‡æ¡£
```

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è¯´æ˜

### 1. é…ç½®æ–‡ä»¶ç®¡ç† (`config/folders.json`)
```json
{
  "folders": [
    {
      "name": "config",                    // æ–‡ä»¶å¤¹åç§°
      "description": "ä¸»è¦é…ç½®æ–‡ä»¶",        // æ–‡ä»¶å¤¹æè¿°
      "local_path_staging": "app-config/config/staging",      // Stagingç¯å¢ƒæœ¬åœ°è·¯å¾„
      "local_path_production": "app-config/config/production", // Productionç¯å¢ƒæœ¬åœ°è·¯å¾„
      "s3_prefix_staging": "config/staging",                  // Stagingç¯å¢ƒS3å‰ç¼€
      "s3_prefix_production": "config/production",            // Productionç¯å¢ƒS3å‰ç¼€
      "files": [                          // ç›‘æ§çš„æ–‡ä»¶åˆ—è¡¨
        {
          "name": "test.json",            // æ–‡ä»¶å
          "description": "ä¸»è¦é…ç½®æ–‡ä»¶"    // æ–‡ä»¶æè¿°
        }
      ]
    }
  ],
  "environments": {                       // ç¯å¢ƒé…ç½®
    "staging": {
      "github_branch": "staging"          // Stagingç¯å¢ƒGitHubåˆ†æ”¯
    },
    "production": {
      "github_branch": "main"             // Productionç¯å¢ƒGitHubåˆ†æ”¯
    }
  }
}
```

### 2. Lambda å‡½æ•°å¤„ç†å™¨ (`handlers/`)

#### `s3-to-github.js` - ä¸»è¦åŒæ­¥å¤„ç†å™¨
- **åŠŸèƒ½**: å¤„ç†S3æ–‡ä»¶å˜æ›´äº‹ä»¶ï¼ŒåŒæ­¥åˆ°GitHub
- **è§¦å‘æ¡ä»¶**: S3æ–‡ä»¶åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤äº‹ä»¶
- **å¤„ç†æµç¨‹**: 
  1. éªŒè¯S3è·¯å¾„æ˜¯å¦åœ¨ç›‘æ§èŒƒå›´å†…
  2. æå–æ–‡ä»¶ä¿¡æ¯å’Œæ–‡ä»¶å¤¹é…ç½®
  3. æ ¹æ®ç¯å¢ƒç¡®å®šGitHubç›®æ ‡è·¯å¾„
  4. æ‰§è¡ŒGitHubæ–‡ä»¶åŒæ­¥æ“ä½œ

#### `s3-to-github-production.js` - ç”Ÿäº§ç¯å¢ƒä¸“ç”¨å¤„ç†å™¨
- **åŠŸèƒ½**: ä¸“é—¨å¤„ç†ç”Ÿäº§ç¯å¢ƒçš„S3åˆ°GitHubåŒæ­¥
- **ç‰¹ç‚¹**: åªå¤„ç†productionç¯å¢ƒçš„æ–‡ä»¶å˜æ›´
- **å®‰å…¨æªæ–½**: é¢å¤–çš„ç”Ÿäº§ç¯å¢ƒéªŒè¯

### 3. å·¥å…·ç±» (`utils/`)

#### `folder-manager.js` - æ–‡ä»¶å¤¹ç®¡ç†å™¨
- **åŠŸèƒ½**: æ ¸å¿ƒé…ç½®ç®¡ç†å·¥å…·ç±»
- **ä¸»è¦æ–¹æ³•**:
  - `getFolders()`: è·å–æ‰€æœ‰æ–‡ä»¶å¤¹é…ç½®
  - `validateFoldersConfig()`: éªŒè¯é…ç½®æœ‰æ•ˆæ€§
  - `fileExists()`: æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
  - `getFileHash()`: è·å–æ–‡ä»¶å“ˆå¸Œå€¼
  - `readFile()`: è¯»å–æ–‡ä»¶å†…å®¹

#### `generate-s3-arns.js` - S3 ARNç”Ÿæˆå™¨
- **åŠŸèƒ½**: æ ¹æ®æ–‡ä»¶å¤¹é…ç½®åŠ¨æ€ç”ŸæˆS3æƒé™ARN
- **ç”¨é€”**: ä¸ºLambdaå‡½æ•°ç”Ÿæˆç²¾ç¡®çš„S3è®¿é—®æƒé™

### 4. ç®¡ç†è„šæœ¬ (`scripts/`)

#### `deploy.js` - éƒ¨ç½²è„šæœ¬
- **åŠŸèƒ½**: å¸¦é…ç½®éªŒè¯çš„å®Œæ•´éƒ¨ç½²
- **æµç¨‹**: éªŒè¯é…ç½® â†’ æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯ â†’ æ‰§è¡ŒServerlesséƒ¨ç½²

#### `sync-folders-to-s3.js` - åŒæ­¥åˆ°S3è„šæœ¬
- **åŠŸèƒ½**: å°†æœ¬åœ°æ–‡ä»¶å¤¹åŒæ­¥åˆ°S3
- **ç‰¹ç‚¹**: æ™ºèƒ½åŒæ­¥ï¼ŒåªåŒæ­¥å˜æ›´çš„æ–‡ä»¶

#### `pull-from-s3.js` - ä»S3æ‹‰å–è„šæœ¬
- **åŠŸèƒ½**: ä»S3æ‹‰å–æ–‡ä»¶åˆ°GitHubä»“åº“
- **ç”¨é€”**: æ¢å¤æˆ–åŒæ­¥S3ä¸­çš„é…ç½®æ–‡ä»¶

#### `monitor-folders-sync.js` - ç›‘æ§è„šæœ¬
- **åŠŸèƒ½**: ç›‘æ§æœ¬åœ°ã€S3ã€GitHubä¸‰æ–¹çš„æ–‡ä»¶åŒæ­¥çŠ¶æ€
- **è¾“å‡º**: è¯¦ç»†çš„åŒæ­¥çŠ¶æ€æŠ¥å‘Š

#### `manage-folders.js` - æ–‡ä»¶å¤¹ç®¡ç†è„šæœ¬
- **åŠŸèƒ½**: ç®¡ç†æ–‡ä»¶å¤¹é…ç½®çš„å¢åˆ æ”¹æŸ¥
- **å‘½ä»¤**: éªŒè¯ã€æ·»åŠ ã€åˆ é™¤ã€åˆ—å‡ºæ–‡ä»¶å¤¹é…ç½®

### 5. Serverless æ’ä»¶ (`plugins/`)

#### `dynamic-s3-events.js` - åŠ¨æ€S3äº‹ä»¶æ’ä»¶
- **åŠŸèƒ½**: æ ¹æ®æ–‡ä»¶å¤¹é…ç½®åŠ¨æ€ç”ŸæˆS3äº‹ä»¶è§„åˆ™
- **è§¦å‘æ—¶æœº**: éƒ¨ç½²å‰è‡ªåŠ¨ç”Ÿæˆäº‹ä»¶é…ç½®
- **ä¼˜åŠ¿**: é¿å…æ‰‹åŠ¨é…ç½®S3äº‹ä»¶ï¼Œå‡å°‘é…ç½®é”™è¯¯

### 6. GitHub Actions å·¥ä½œæµ (`.github/workflows/`)

#### `github-to-s3-staging-sync.yml` - Stagingç¯å¢ƒåŒæ­¥
- **è§¦å‘æ¡ä»¶**: stagingåˆ†æ”¯çš„app-config/**æˆ–config/folders.jsonå˜æ›´
- **åŠŸèƒ½**: è‡ªåŠ¨åŒæ­¥stagingç¯å¢ƒé…ç½®åˆ°S3

#### `github-to-s3-production-sync.yml` - Productionç¯å¢ƒåŒæ­¥
- **è§¦å‘æ¡ä»¶**: mainåˆ†æ”¯çš„app-config/**æˆ–config/folders.jsonå˜æ›´
- **åŠŸèƒ½**: è‡ªåŠ¨åŒæ­¥productionç¯å¢ƒé…ç½®åˆ°S3

## ğŸ”„ æ•°æ®æµå‘

### 1. GitHub â†’ S3 åŒæ­¥æµç¨‹
```
GitHubä»“åº“ (app-config/) 
    â†“ (GitHub Actions)
æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ
    â†“ (sync-folders-to-s3.js)
AWS S3 (rock-service-data/)
```

### 2. S3 â†’ GitHub åŒæ­¥æµç¨‹
```
AWS S3 (rock-service-data/)
    â†“ (S3äº‹ä»¶è§¦å‘)
Lambdaå‡½æ•° (s3-to-github.js)
    â†“ (GitHub API)
GitHubä»“åº“ (å¯¹åº”åˆ†æ”¯)
```

### 3. ç›‘æ§å’ŒéªŒè¯æµç¨‹
```
æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ
    â†“
monitor-folders-sync.js
    â†“
S3æ–‡ä»¶çŠ¶æ€
    â†“
GitHubæ–‡ä»¶çŠ¶æ€
    â†“
åŒæ­¥çŠ¶æ€æŠ¥å‘Š
```

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **åç«¯**: Node.js 18.x
- **äº‘æœåŠ¡**: AWS Lambda, AWS S3
- **éƒ¨ç½²**: Serverless Framework
- **CI/CD**: GitHub Actions
- **ç‰ˆæœ¬æ§åˆ¶**: Git
- **åŒ…ç®¡ç†**: npm

## ğŸ“‹ ç¯å¢ƒå˜é‡é…ç½®

### å¿…éœ€ç¯å¢ƒå˜é‡
```bash
# AWSé…ç½®
AWS_ACCESS_KEY_ID=your_aws_access_key
AWS_SECRET_ACCESS_KEY=your_aws_secret_key
AWS_REGION=ap-southeast-2

# GitHubé…ç½®
GITHUB_TOKEN=your_github_token
GITHUB_REPO=s2265681/data-config-admin

# S3é…ç½®
S3_BUCKET=rock-service-data
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–
```bash
npm install
```

### 2. é…ç½®ç¯å¢ƒå˜é‡
```bash
cp env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå¡«å…¥å®é™…çš„é…ç½®å€¼
```

### 3. éƒ¨ç½²åˆ°AWS
```bash
npm run deploy-with-validation
```

### 4. æµ‹è¯•åŒæ­¥åŠŸèƒ½
```bash
# åŒæ­¥åˆ°S3
npm run sync-to-s3

# ç›‘æ§åŒæ­¥çŠ¶æ€
npm run monitor
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [README.md](./README.md) - é¡¹ç›®ä¸»è¦è¯´æ˜
- [SETUP.md](./SETUP.md) - è¯¦ç»†è®¾ç½®æŒ‡å—
- [FOLDER_MANAGEMENT.md](./FOLDER_MANAGEMENT.md) - æ–‡ä»¶å¤¹ç®¡ç†è¯´æ˜
- [SCRIPTS_USAGE.md](./SCRIPTS_USAGE.md) - è„šæœ¬ä½¿ç”¨æŒ‡å—
- [æŠ€æœ¯æ–‡æ¡£.md](./æŠ€æœ¯æ–‡æ¡£.md) - æŠ€æœ¯å®ç°ç»†èŠ‚

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜
1. **é…ç½®éªŒè¯å¤±è´¥**: æ£€æŸ¥ `config/folders.json` æ ¼å¼
2. **æƒé™é”™è¯¯**: ç¡®è®¤AWSå’ŒGitHubæƒé™é…ç½®
3. **åŒæ­¥å¤±è´¥**: æŸ¥çœ‹Lambdaå‡½æ•°æ—¥å¿—
4. **æ–‡ä»¶å†²çª**: ä½¿ç”¨ç›‘æ§è„šæœ¬æ£€æŸ¥æ–‡ä»¶çŠ¶æ€

### æ—¥å¿—æŸ¥çœ‹
```bash
# æŸ¥çœ‹Lambdaå‡½æ•°æ—¥å¿—
serverless logs -f s3ToGithubSync --tail

# æŸ¥çœ‹GitHub Actionsæ—¥å¿—
# åœ¨GitHubä»“åº“çš„Actionsé¡µé¢æŸ¥çœ‹
```

---

*æœ€åæ›´æ–°: 2024å¹´12æœˆ* 